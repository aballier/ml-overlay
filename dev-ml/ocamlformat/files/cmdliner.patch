From 2d6931e64f3b07efc6374925c5b0cf7b346148f2 Mon Sep 17 00:00:00 2001
From: Etienne Millon <me@emillon.org>
Date: Wed, 9 Apr 2025 15:31:37 +0200
Subject: [PATCH] use Arg.conv functions instead of tuples

This representation is made abstract in cmdliner 2.0.0.
---
 lib/Conf_decl.ml         | 10 ++--------
 lib/bin_conf/Bin_conf.ml | 10 +++++-----
 3 files changed, 17 insertions(+), 13 deletions(-)

diff --git a/lib/Conf_decl.ml b/lib/Conf_decl.ml
index e5b6c24eb3..aedceffd27 100644
--- a/lib/Conf_decl.ml
+++ b/lib/Conf_decl.ml
@@ -11,14 +11,6 @@
 
 module Error = Conf_t.Error
 
-let ocaml_version_conv =
-  let parse x =
-    match Ocaml_version.of_string x with
-    | Ok x -> `Ok x
-    | Error (`Msg x) -> `Error x
-  in
-  (parse, Ocaml_version.pp)
-
 type typ = Int | Bool | Ocaml_version | Choice of string list
 
 module UI = struct
@@ -31,6 +23,8 @@ end
 
 open Cmdliner
 
+let ocaml_version_conv = Arg.conv (Ocaml_version.of_string, Ocaml_version.pp)
+
 type kind = Formatting | Operational
 (* type from = [ `Default | `Profile of string * updated_from | `Updated of
    updated_from * from option (* when redundant definition *) ] *)
diff --git a/lib/bin_conf/Bin_conf.ml b/lib/bin_conf/Bin_conf.ml
index 26b15c6f7c..4af80cb757 100644
--- a/lib/bin_conf/Bin_conf.ml
+++ b/lib/bin_conf/Bin_conf.ml
@@ -166,17 +166,17 @@ let check =
 let inputs =
   let docv = "SRC" in
   let file_or_dash =
-    let parse, print = Arg.non_dir_file in
+    let parse = Arg.conv_parser Arg.non_dir_file in
+    let print = Arg.conv_printer Arg.non_dir_file in
     let print fmt = function
       | Stdin -> print fmt "<standard input>"
       | File x -> print fmt x
     in
     let parse = function
-      | "-" -> `Ok Stdin
-      | s -> (
-        match parse s with `Ok x -> `Ok (File x) | `Error x -> `Error x )
+      | "-" -> Ok Stdin
+      | s -> parse s |> Result.map ~f:(fun x -> File x)
     in
-    (parse, print)
+    Arg.conv (parse, print)
   in
   let doc =
     "Input files. At least one is required, and exactly one without \
