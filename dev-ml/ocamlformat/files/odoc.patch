From cc72e1d666ef5ee5f1c0f8f90788ffd52858a36e Mon Sep 17 00:00:00 2001
From: Guillaume Petiot <guillaume@tarides.com>
Date: Fri, 8 Jul 2022 09:51:42 +0100
Subject: [PATCH 2/7] support Math_span and Math_block

---
 lib/Docstring.ml                              |  2 ++
 lib/Fmt_odoc.ml                               | 13 +++++++++++
 .../doc_comments-no-parse-docstrings.mli.err  |  2 ++
 .../doc_comments-no-parse-docstrings.mli.ref  | 22 +++++++++++++++++++
 .../tests/doc_comments-no-wrap.mli.err        |  3 +++
 .../tests/doc_comments-no-wrap.mli.ref        | 21 ++++++++++++++++++
 test/passing/tests/doc_comments.mli           | 22 +++++++++++++++++++
 test/passing/tests/doc_comments.mli.err       |  3 +++
 test/passing/tests/doc_comments.mli.ref       | 21 ++++++++++++++++++
 9 files changed, 109 insertions(+)

diff --git a/lib/Docstring.ml b/lib/Docstring.ml
index 4a7701e38..83ce694a8 100644
--- a/lib/Docstring.ml
+++ b/lib/Docstring.ml
@@ -75,6 +75,7 @@ let rec odoc_inline_element fmt = function
       in
       fpf fmt "Word(%a)" str txt
   | `Code_span txt -> fpf fmt "Code_span(%a)" str txt
+  | `Math_span txt -> fpf fmt "Math_span(%a)" str txt
   | `Raw_markup (Some lang, txt) -> fpf fmt "Raw_markup(%s,%a)" lang str txt
   | `Raw_markup (None, txt) -> fpf fmt "Raw_markup(%a)" str txt
   | `Styled (style, elems) ->
@@ -97,6 +98,7 @@ let rec odoc_nestable_block_element c fmt = function
         option (pair (ign_loc str) (option (ign_loc str)))
       in
       fpf fmt "Code_block(%a, %a)" fmt_metadata metadata str txt
+  | `Math_block txt -> fpf fmt "Math_block(%a)" str txt
   | `Verbatim txt -> fpf fmt "Verbatim(%a)" str txt
   | `Modules mods -> fpf fmt "Modules(%a)" (list odoc_reference) mods
   | `List (ord, _syntax, items) ->
diff --git a/lib/Fmt_odoc.ml b/lib/Fmt_odoc.ml
index 0ada65851..93dc0dada 100644
--- a/lib/Fmt_odoc.ml
+++ b/lib/Fmt_odoc.ml
@@ -103,6 +103,17 @@ let fmt_code_block conf s1 s2 =
 
 let fmt_code_span s = hovbox 0 (wrap "[" "]" (str (escape_brackets s)))
 
+let fmt_math_span s = hovbox 2 (wrap "{m " "}" (str s))
+
+let fmt_math_block s =
+  let lines =
+    List.rev
+    @@ List.drop_while ~f:String.is_empty
+    @@ List.rev_map ~f:String.strip
+    @@ String.split_lines s
+  in
+  hvbox 2 (wrap "{math@;" "@;<0 -2>}" (list lines "@;" str))
+
 let fmt_reference = ign_loc ~f:str_normalized
 
 (* Decide between using light and heavy syntax for lists *)
@@ -161,6 +172,7 @@ let rec fmt_inline_elements elements =
     | `Space _ :: t -> fmt "@ " $ aux t
     | `Word w :: t -> str_normalized w $ aux t
     | `Code_span s :: t -> fmt_code_span s $ aux t
+    | `Math_span s :: t -> fmt_math_span s $ aux t
     | `Raw_markup (lang, s) :: t ->
         let lang =
           match lang with
@@ -193,6 +205,7 @@ let rec fmt_inline_elements elements =
 and fmt_nestable_block_element c = function
   | `Paragraph elems -> fmt_inline_elements elems
   | `Code_block (s1, s2) -> fmt_code_block c s1 s2
+  | `Math_block s -> fmt_math_block s
   | `Verbatim s -> fmt_verbatim_block s
   | `Modules mods ->
       hovbox 0
diff --git a/test/passing/tests/doc_comments-no-parse-docstrings.mli.err b/test/passing/tests/doc_comments-no-parse-docstrings.mli.err
index 21f006229..6719286ae 100644
--- a/test/passing/tests/doc_comments-no-parse-docstrings.mli.err
+++ b/test/passing/tests/doc_comments-no-parse-docstrings.mli.err
@@ -20,3 +20,5 @@ Warning: tests/doc_comments.mli:547 exceeds the margin
 Warning: tests/doc_comments.mli:549 exceeds the margin
 Warning: tests/doc_comments.mli:551 exceeds the margin
 Warning: tests/doc_comments.mli:575 exceeds the margin
+Warning: tests/doc_comments.mli:585 exceeds the margin
+Warning: tests/doc_comments.mli:595 exceeds the margin
diff --git a/test/passing/tests/doc_comments-no-parse-docstrings.mli.ref b/test/passing/tests/doc_comments-no-parse-docstrings.mli.ref
index 1f25d5f52..29dcfdc2c 100644
--- a/test/passing/tests/doc_comments-no-parse-docstrings.mli.ref
+++ b/test/passing/tests/doc_comments-no-parse-docstrings.mli.ref
@@ -580,3 +580,25 @@ type x =
 (**a*)
 
 (**b*)
+
+(** Inline math: {m \infty}
+
+    Inline math elements can wrap as well {m \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty} or {m \f\relax{x} = \int_{-\infty}^\infty \f\hat\xi\,e^{2 \pi i \xi x} \,d\xi}.
+
+    Block math:
+
+    {math \infty}
+
+    {math
+    \infty
+    }
+
+    {math {m \f\relax{x} = \int_{-\infty}^\infty \f\hat\xi\,e^{2 \pi i \xi x} \,d\xi}}
+
+    {math
+    % \f is defined as #1f(#2) using the macro
+    \f\relax{x} = \int_{-\infty}^\infty
+    \f\hat\xi\,e^{2 \pi i \xi x}
+    \,d\xi
+    }
+*)
diff --git a/test/passing/tests/doc_comments-no-wrap.mli.err b/test/passing/tests/doc_comments-no-wrap.mli.err
index c0ffb1f1a..b043829c8 100644
--- a/test/passing/tests/doc_comments-no-wrap.mli.err
+++ b/test/passing/tests/doc_comments-no-wrap.mli.err
@@ -14,3 +14,6 @@ Warning: tests/doc_comments.mli:424 exceeds the margin
 Warning: tests/doc_comments.mli:437 exceeds the margin
 Warning: tests/doc_comments.mli:494 exceeds the margin
 Warning: tests/doc_comments.mli:524 exceeds the margin
+Warning: tests/doc_comments.mli:594 exceeds the margin
+Warning: tests/doc_comments.mli:596 exceeds the margin
+Warning: tests/doc_comments.mli:603 exceeds the margin
diff --git a/test/passing/tests/doc_comments-no-wrap.mli.ref b/test/passing/tests/doc_comments-no-wrap.mli.ref
index f18a6fb63..a194fbb70 100644
--- a/test/passing/tests/doc_comments-no-wrap.mli.ref
+++ b/test/passing/tests/doc_comments-no-wrap.mli.ref
@@ -588,3 +588,24 @@ type x =
 (**a*)
 
 (**b*)
+
+(** Inline math: {m \infty}
+
+    Inline math elements can wrap as well
+    {m \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty}
+    or
+    {m \f\relax{x} = \int_{-\infty}^\infty \f\hat\xi\,e^{2 \pi i \xi x} \,d\xi}.
+
+    Block math:
+
+    {math \infty}
+    {math \infty}
+    {math
+      {m \f\relax{x} = \int_{-\infty}^\infty \f\hat\xi\,e^{2 \pi i \xi x} \,d\xi}
+    }
+    {math
+      % \f is defined as #1f(#2) using the macro
+      \f\relax{x} = \int_{-\infty}^\infty
+      \f\hat\xi\,e^{2 \pi i \xi x}
+      \,d\xi
+    } *)
diff --git a/test/passing/tests/doc_comments.mli b/test/passing/tests/doc_comments.mli
index 5c7e573f6..b26295249 100644
--- a/test/passing/tests/doc_comments.mli
+++ b/test/passing/tests/doc_comments.mli
@@ -588,3 +588,25 @@ type x =
     {@sh[ echo "this""is""only""a""single"(echo word)(echo also) ]} *)
 
 (**a*)(**b*)
+
+(** Inline math: {m \infty}
+
+    Inline math elements can wrap as well {m \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty} or {m \f\relax{x} = \int_{-\infty}^\infty \f\hat\xi\,e^{2 \pi i \xi x} \,d\xi}.
+
+    Block math:
+
+    {math \infty}
+
+    {math
+    \infty
+    }
+
+    {math {m \f\relax{x} = \int_{-\infty}^\infty \f\hat\xi\,e^{2 \pi i \xi x} \,d\xi}}
+
+    {math
+    % \f is defined as #1f(#2) using the macro
+    \f\relax{x} = \int_{-\infty}^\infty
+    \f\hat\xi\,e^{2 \pi i \xi x}
+    \,d\xi
+    }
+*)
diff --git a/test/passing/tests/doc_comments.mli.err b/test/passing/tests/doc_comments.mli.err
index c0ffb1f1a..71d3c55bf 100644
--- a/test/passing/tests/doc_comments.mli.err
+++ b/test/passing/tests/doc_comments.mli.err
@@ -14,3 +14,6 @@ Warning: tests/doc_comments.mli:424 exceeds the margin
 Warning: tests/doc_comments.mli:437 exceeds the margin
 Warning: tests/doc_comments.mli:494 exceeds the margin
 Warning: tests/doc_comments.mli:524 exceeds the margin
+Warning: tests/doc_comments.mli:588 exceeds the margin
+Warning: tests/doc_comments.mli:590 exceeds the margin
+Warning: tests/doc_comments.mli:597 exceeds the margin
diff --git a/test/passing/tests/doc_comments.mli.ref b/test/passing/tests/doc_comments.mli.ref
index 0cf11de39..b095402c1 100644
--- a/test/passing/tests/doc_comments.mli.ref
+++ b/test/passing/tests/doc_comments.mli.ref
@@ -582,3 +582,24 @@ type x =
 (**a*)
 
 (**b*)
+
+(** Inline math: {m \infty}
+
+    Inline math elements can wrap as well
+    {m \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty \infty}
+    or
+    {m \f\relax{x} = \int_{-\infty}^\infty \f\hat\xi\,e^{2 \pi i \xi x} \,d\xi}.
+
+    Block math:
+
+    {math \infty}
+    {math \infty}
+    {math
+      {m \f\relax{x} = \int_{-\infty}^\infty \f\hat\xi\,e^{2 \pi i \xi x} \,d\xi}
+    }
+    {math
+      % \f is defined as #1f(#2) using the macro
+      \f\relax{x} = \int_{-\infty}^\infty
+      \f\hat\xi\,e^{2 \pi i \xi x}
+      \,d\xi
+    } *)

From 8bc54221429c7de59704e6d16c99c2a8730fefab Mon Sep 17 00:00:00 2001
From: Guillaume Petiot <guillaume@tarides.com>
Date: Fri, 8 Jul 2022 11:51:45 +0100
Subject: [PATCH 3/7] changelog

---
 CHANGES.md | 13 +++++++++----
 1 file changed, 9 insertions(+), 4 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index ad79eeb68..3d6ff259c 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -1,11 +1,18 @@
+## (unreleased)
+
+### New features
+
+- Support `odoc-parser.2.0.0` (#<PR_NUMBER>, @gpetiot)
+  * Breaking change: incompatible with earlier versions of `odoc-parser`
+  * New inline math elements `{m ...}` available in doc-comments
+  * New block math elements `{math ...}` available in doc-comments
+
 ## 0.23.0 (2022-07-07)
 
 ### Removed
 
 - `bench` binary is not distributed anymore to avoid name collisions (#2104, @gpetiot)
 
-### Deprecated
-
 ### Bug fixes
 
 - Preserve comments around object open/close flag (#2097, @trefis, @gpetiot)
@@ -19,8 +26,6 @@
 - JaneStreet profile: set `max-indent = 2` (#2099, @gpetiot)
 - JaneStreet profile: align pattern-matching bar `|` under keyword instead of parenthesis (#2102, @gpetiot)
 
-### New features
-
 ## 0.22.4 (2022-05-26)
 
 ### Removed

From a6b34652e75cc8257c6d162f2c6d31f60bcc0837 Mon Sep 17 00:00:00 2001
From: Guillaume Petiot <guillaume@tarides.com>
Date: Fri, 8 Jul 2022 11:53:51 +0100
Subject: [PATCH 4/7] Update CHANGES.md

Co-authored-by: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
---
 CHANGES.md | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/CHANGES.md b/CHANGES.md
index 3d6ff259c..bafaaa590 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -2,7 +2,7 @@
 
 ### New features
 
-- Support `odoc-parser.2.0.0` (#<PR_NUMBER>, @gpetiot)
+- Support `odoc-parser.2.0.0` (#2123, @gpetiot)
   * Breaking change: incompatible with earlier versions of `odoc-parser`
   * New inline math elements `{m ...}` available in doc-comments
   * New block math elements `{math ...}` available in doc-comments

From 9165720581ccb8572bd3e8d09efdbb807e865339 Mon Sep 17 00:00:00 2001
From: Guillaume Petiot <guillaume@tarides.com>
Date: Fri, 8 Jul 2022 19:43:36 +0100
Subject: [PATCH 5/7] Update lib/Fmt_odoc.ml

Co-authored-by: Jules Aguillon <jules@j3s.fr>
---
 lib/Fmt_odoc.ml | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/lib/Fmt_odoc.ml b/lib/Fmt_odoc.ml
index 93dc0dada..6dcfef847 100644
--- a/lib/Fmt_odoc.ml
+++ b/lib/Fmt_odoc.ml
@@ -107,7 +107,8 @@ let fmt_math_span s = hovbox 2 (wrap "{m " "}" (str s))
 
 let fmt_math_block s =
   let lines =
-    List.rev
+    List.drop_while ~f:String.is_empty
+    @@ List.rev
     @@ List.drop_while ~f:String.is_empty
     @@ List.rev_map ~f:String.strip
     @@ String.split_lines s

From 6a488003dc9b44e1a5d64a917073032bda769a59 Mon Sep 17 00:00:00 2001
From: Guillaume Petiot <guillaume@tarides.com>
Date: Fri, 8 Jul 2022 20:28:31 +0100
Subject: [PATCH 6/7] fix math block

---
 lib/Fmt_odoc.ml                                    |  7 ++++++-
 .../tests/doc_comments-no-parse-docstrings.mli.err |  2 +-
 .../tests/doc_comments-no-parse-docstrings.mli.ref | 14 ++++++++++++++
 test/passing/tests/doc_comments-no-wrap.mli.err    |  2 +-
 test/passing/tests/doc_comments-no-wrap.mli.ref    |  6 ++++++
 test/passing/tests/doc_comments.mli                | 14 ++++++++++++++
 test/passing/tests/doc_comments.mli.err            |  2 +-
 test/passing/tests/doc_comments.mli.ref            |  6 ++++++
 8 files changed, 49 insertions(+), 4 deletions(-)

diff --git a/lib/Fmt_odoc.ml b/lib/Fmt_odoc.ml
index 6dcfef847..8aa870b44 100644
--- a/lib/Fmt_odoc.ml
+++ b/lib/Fmt_odoc.ml
@@ -113,7 +113,12 @@ let fmt_math_block s =
     @@ List.rev_map ~f:String.strip
     @@ String.split_lines s
   in
-  hvbox 2 (wrap "{math@;" "@;<0 -2>}" (list lines "@;" str))
+  let fmt ~first ~last:_ line =
+    if first then str line
+    else if String.is_empty line then str "\n"
+    else fmt "@;<1000 0>" $ str line
+  in
+  hvbox 2 (wrap "{math@;" "@;<0 -2>}" (list_fl lines fmt))
 
 let fmt_reference = ign_loc ~f:str_normalized
 
diff --git a/test/passing/tests/doc_comments-no-parse-docstrings.mli.err b/test/passing/tests/doc_comments-no-parse-docstrings.mli.err
index 6719286ae..56843c7b8 100644
--- a/test/passing/tests/doc_comments-no-parse-docstrings.mli.err
+++ b/test/passing/tests/doc_comments-no-parse-docstrings.mli.err
@@ -21,4 +21,4 @@ Warning: tests/doc_comments.mli:549 exceeds the margin
 Warning: tests/doc_comments.mli:551 exceeds the margin
 Warning: tests/doc_comments.mli:575 exceeds the margin
 Warning: tests/doc_comments.mli:585 exceeds the margin
-Warning: tests/doc_comments.mli:595 exceeds the margin
+Warning: tests/doc_comments.mli:609 exceeds the margin
diff --git a/test/passing/tests/doc_comments-no-parse-docstrings.mli.ref b/test/passing/tests/doc_comments-no-parse-docstrings.mli.ref
index 29dcfdc2c..240e88569 100644
--- a/test/passing/tests/doc_comments-no-parse-docstrings.mli.ref
+++ b/test/passing/tests/doc_comments-no-parse-docstrings.mli.ref
@@ -593,6 +593,20 @@ type x =
     \infty
     }
 
+    {math
+
+    \pi
+
+    }
+
+    {math
+
+    \infty
+
+    \pi
+
+    }
+
     {math {m \f\relax{x} = \int_{-\infty}^\infty \f\hat\xi\,e^{2 \pi i \xi x} \,d\xi}}
 
     {math
diff --git a/test/passing/tests/doc_comments-no-wrap.mli.err b/test/passing/tests/doc_comments-no-wrap.mli.err
index b043829c8..f5ece71ba 100644
--- a/test/passing/tests/doc_comments-no-wrap.mli.err
+++ b/test/passing/tests/doc_comments-no-wrap.mli.err
@@ -16,4 +16,4 @@ Warning: tests/doc_comments.mli:494 exceeds the margin
 Warning: tests/doc_comments.mli:524 exceeds the margin
 Warning: tests/doc_comments.mli:594 exceeds the margin
 Warning: tests/doc_comments.mli:596 exceeds the margin
-Warning: tests/doc_comments.mli:603 exceeds the margin
+Warning: tests/doc_comments.mli:609 exceeds the margin
diff --git a/test/passing/tests/doc_comments-no-wrap.mli.ref b/test/passing/tests/doc_comments-no-wrap.mli.ref
index a194fbb70..020a8f066 100644
--- a/test/passing/tests/doc_comments-no-wrap.mli.ref
+++ b/test/passing/tests/doc_comments-no-wrap.mli.ref
@@ -600,6 +600,12 @@ type x =
 
     {math \infty}
     {math \infty}
+    {math \pi}
+    {math
+      \infty
+
+      \pi
+    }
     {math
       {m \f\relax{x} = \int_{-\infty}^\infty \f\hat\xi\,e^{2 \pi i \xi x} \,d\xi}
     }
diff --git a/test/passing/tests/doc_comments.mli b/test/passing/tests/doc_comments.mli
index b26295249..2d0e7f70a 100644
--- a/test/passing/tests/doc_comments.mli
+++ b/test/passing/tests/doc_comments.mli
@@ -601,6 +601,20 @@ type x =
     \infty
     }
 
+    {math
+
+    \pi
+
+    }
+
+    {math
+
+    \infty
+
+    \pi
+
+    }
+
     {math {m \f\relax{x} = \int_{-\infty}^\infty \f\hat\xi\,e^{2 \pi i \xi x} \,d\xi}}
 
     {math
diff --git a/test/passing/tests/doc_comments.mli.err b/test/passing/tests/doc_comments.mli.err
index 71d3c55bf..0ec7fef4b 100644
--- a/test/passing/tests/doc_comments.mli.err
+++ b/test/passing/tests/doc_comments.mli.err
@@ -16,4 +16,4 @@ Warning: tests/doc_comments.mli:494 exceeds the margin
 Warning: tests/doc_comments.mli:524 exceeds the margin
 Warning: tests/doc_comments.mli:588 exceeds the margin
 Warning: tests/doc_comments.mli:590 exceeds the margin
-Warning: tests/doc_comments.mli:597 exceeds the margin
+Warning: tests/doc_comments.mli:603 exceeds the margin
diff --git a/test/passing/tests/doc_comments.mli.ref b/test/passing/tests/doc_comments.mli.ref
index b095402c1..ce81e095c 100644
--- a/test/passing/tests/doc_comments.mli.ref
+++ b/test/passing/tests/doc_comments.mli.ref
@@ -594,6 +594,12 @@ type x =
 
     {math \infty}
     {math \infty}
+    {math \pi}
+    {math
+      \infty
+
+      \pi
+    }
     {math
       {m \f\relax{x} = \int_{-\infty}^\infty \f\hat\xi\,e^{2 \pi i \xi x} \,d\xi}
     }

From 42ff915f28be524899a070ec69d2f98187457642 Mon Sep 17 00:00:00 2001
From: Guillaume Petiot <guillaume@tarides.com>
Date: Fri, 8 Jul 2022 20:55:22 +0100
Subject: [PATCH 7/7] more tests

---
 test/passing/tests/doc_comments-no-parse-docstrings.mli.err | 2 +-
 test/passing/tests/doc_comments-no-parse-docstrings.mli.ref | 4 ++++
 test/passing/tests/doc_comments-no-wrap.mli.err             | 2 +-
 test/passing/tests/doc_comments-no-wrap.mli.ref             | 4 ++++
 test/passing/tests/doc_comments.mli                         | 4 ++++
 test/passing/tests/doc_comments.mli.err                     | 2 +-
 test/passing/tests/doc_comments.mli.ref                     | 4 ++++
 7 files changed, 19 insertions(+), 3 deletions(-)

diff --git a/test/passing/tests/doc_comments-no-parse-docstrings.mli.err b/test/passing/tests/doc_comments-no-parse-docstrings.mli.err
index 56843c7b8..68437452f 100644
--- a/test/passing/tests/doc_comments-no-parse-docstrings.mli.err
+++ b/test/passing/tests/doc_comments-no-parse-docstrings.mli.err
@@ -21,4 +21,4 @@ Warning: tests/doc_comments.mli:549 exceeds the margin
 Warning: tests/doc_comments.mli:551 exceeds the margin
 Warning: tests/doc_comments.mli:575 exceeds the margin
 Warning: tests/doc_comments.mli:585 exceeds the margin
-Warning: tests/doc_comments.mli:609 exceeds the margin
+Warning: tests/doc_comments.mli:613 exceeds the margin
diff --git a/test/passing/tests/doc_comments-no-parse-docstrings.mli.ref b/test/passing/tests/doc_comments-no-parse-docstrings.mli.ref
index 240e88569..df46bac62 100644
--- a/test/passing/tests/doc_comments-no-parse-docstrings.mli.ref
+++ b/test/passing/tests/doc_comments-no-parse-docstrings.mli.ref
@@ -603,6 +603,10 @@ type x =
 
     \infty
 
+   \pi
+
+       \pi
+
     \pi
 
     }
diff --git a/test/passing/tests/doc_comments-no-wrap.mli.err b/test/passing/tests/doc_comments-no-wrap.mli.err
index f5ece71ba..d3ba93ac0 100644
--- a/test/passing/tests/doc_comments-no-wrap.mli.err
+++ b/test/passing/tests/doc_comments-no-wrap.mli.err
@@ -16,4 +16,4 @@ Warning: tests/doc_comments.mli:494 exceeds the margin
 Warning: tests/doc_comments.mli:524 exceeds the margin
 Warning: tests/doc_comments.mli:594 exceeds the margin
 Warning: tests/doc_comments.mli:596 exceeds the margin
-Warning: tests/doc_comments.mli:609 exceeds the margin
+Warning: tests/doc_comments.mli:613 exceeds the margin
diff --git a/test/passing/tests/doc_comments-no-wrap.mli.ref b/test/passing/tests/doc_comments-no-wrap.mli.ref
index 020a8f066..cb813a8a7 100644
--- a/test/passing/tests/doc_comments-no-wrap.mli.ref
+++ b/test/passing/tests/doc_comments-no-wrap.mli.ref
@@ -605,6 +605,10 @@ type x =
       \infty
 
       \pi
+
+      \pi
+
+      \pi
     }
     {math
       {m \f\relax{x} = \int_{-\infty}^\infty \f\hat\xi\,e^{2 \pi i \xi x} \,d\xi}
diff --git a/test/passing/tests/doc_comments.mli b/test/passing/tests/doc_comments.mli
index 2d0e7f70a..6eafc5f6d 100644
--- a/test/passing/tests/doc_comments.mli
+++ b/test/passing/tests/doc_comments.mli
@@ -611,6 +611,10 @@ type x =
 
     \infty
 
+   \pi
+
+       \pi
+
     \pi
 
     }
diff --git a/test/passing/tests/doc_comments.mli.err b/test/passing/tests/doc_comments.mli.err
index 0ec7fef4b..48b64adb4 100644
--- a/test/passing/tests/doc_comments.mli.err
+++ b/test/passing/tests/doc_comments.mli.err
@@ -16,4 +16,4 @@ Warning: tests/doc_comments.mli:494 exceeds the margin
 Warning: tests/doc_comments.mli:524 exceeds the margin
 Warning: tests/doc_comments.mli:588 exceeds the margin
 Warning: tests/doc_comments.mli:590 exceeds the margin
-Warning: tests/doc_comments.mli:603 exceeds the margin
+Warning: tests/doc_comments.mli:607 exceeds the margin
diff --git a/test/passing/tests/doc_comments.mli.ref b/test/passing/tests/doc_comments.mli.ref
index ce81e095c..dc0e3f597 100644
--- a/test/passing/tests/doc_comments.mli.ref
+++ b/test/passing/tests/doc_comments.mli.ref
@@ -599,6 +599,10 @@ type x =
       \infty
 
       \pi
+
+      \pi
+
+      \pi
     }
     {math
       {m \f\relax{x} = \int_{-\infty}^\infty \f\hat\xi\,e^{2 \pi i \xi x} \,d\xi}
