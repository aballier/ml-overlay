From d025cbf619beccaf47397bdadc0a138f7f0fd6ed Mon Sep 17 00:00:00 2001
From: Sora Morimoto <sora@morimoto.io>
Date: Thu, 21 Oct 2021 20:37:07 +0900
Subject: [PATCH] Adopt ocaml-conduit 5.0.0

Signed-off-by: Sora Morimoto <sora@morimoto.io>
---
 CHANGES.md                 | 1 +
 cohttp-lwt-unix.opam       | 4 ++--
 cohttp-lwt-unix/src/net.ml | 7 +++++--
 3 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/cohttp-lwt-unix/src/net.ml b/cohttp-lwt-unix/src/net.ml
index 146d249f83..e32ca95c36 100644
--- a/cohttp-lwt-unix/src/net.ml
+++ b/cohttp-lwt-unix/src/net.ml
@@ -23,12 +23,15 @@ module IO = Io
 type ctx = { ctx : Conduit_lwt_unix.ctx; resolver : Resolver_lwt.t }
 [@@deriving sexp_of]
 
-let init ?(ctx = Conduit_lwt_unix.default_ctx)
+let init ?(ctx = Lazy.force Conduit_lwt_unix.default_ctx)
     ?(resolver = Resolver_lwt_unix.system) () =
   { ctx; resolver }
 
 let default_ctx =
-  { resolver = Resolver_lwt_unix.system; ctx = Conduit_lwt_unix.default_ctx }
+  {
+    resolver = Resolver_lwt_unix.system;
+    ctx = Lazy.force Conduit_lwt_unix.default_ctx;
+  }
 
 let connect_uri ~ctx:{ ctx; resolver } uri =
   Resolver_lwt.resolve_uri ~uri resolver >>= fun endp ->
