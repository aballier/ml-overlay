From b73b5861449343c852a0c1c88dc75931b2a2e8fc Mon Sep 17 00:00:00 2001
From: Sonja Heinze <sonjaleaheinze@gmail.com>
Date: Thu, 28 Jan 2021 17:48:31 +0100
Subject: [PATCH] Achieve compatibility with ppxlib 0.22.0

In ppxlib 0.22.0, the AST gets bumped to ocaml 4.12. This commit adapts
to the compiler changes from 4.11 to 4.12: mainly, the introduction of
injectivity to type declarations.

Signed-off-by: Sonja Heinze <sonjaleaheinze@gmail.com>
---
 ppx_typerep_conv.opam   | 2 +-
 src/ppx_typerep_conv.ml | 4 ++--
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/ppx_typerep_conv.opam b/ppx_typerep_conv.opam
index 6e7fda2..99e08f9 100644
--- a/ppx_typerep_conv.opam
+++ b/ppx_typerep_conv.opam
@@ -15,7 +15,7 @@ depends: [
   "base"    {>= "v0.14" & < "v0.15"}
   "typerep" {>= "v0.14" & < "v0.15"}
   "dune"    {>= "2.0.0"}
-  "ppxlib"  {>= "0.14.0"}
+  "ppxlib"  {>= "0.22.0"}
 ]
 synopsis: "Generation of runtime types from type declarations"
 description: "
diff --git a/src/ppx_typerep_conv.ml b/src/ppx_typerep_conv.ml
index 6e92817..15fa079 100644
--- a/src/ppx_typerep_conv.ml
+++ b/src/ppx_typerep_conv.ml
@@ -184,7 +184,7 @@ module Typerep_implementation = struct
 
     val arg_of_param : string -> string
 
-    val params_names : params:(core_type * variance) list -> string list
+    val params_names : params:(core_type * (variance * injectivity)) list -> string list
     val params_patts : loc:Location.t -> params_names:string list -> pattern list
 
     val type_name_module_definition : loc:Location.t -> path:string ->
@@ -233,7 +233,7 @@ module Typerep_implementation = struct
     let str_item_type_and_name ~loc ~path ~params_names ~type_name =
       let params =
         List.map params_names
-          ~f:(fun name -> (ptyp_var ~loc name, Invariant))
+          ~f:(fun name -> (ptyp_var ~loc name, (NoVariance, NoInjectivity)))
       in
       let td =
         let manifest =
